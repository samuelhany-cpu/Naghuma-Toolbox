Write-Host ""
Write-Host "??????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?   OCR COMPLETE FIX - MASTER SCRIPT    ?" -ForegroundColor Yellow
Write-Host "??????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""
Write-Host "This script will:" -ForegroundColor White
Write-Host "  1. Add OCR files to .vcxproj" -ForegroundColor Gray
Write-Host "  2. Update .vcxproj.filters" -ForegroundColor Gray
Write-Host "  3. Regenerate MOC file" -ForegroundColor Gray
Write-Host "  4. Clean and rebuild project" -ForegroundColor Gray
Write-Host "  5. Verify build success" -ForegroundColor Gray
Write-Host ""
Write-Host "Press any key to continue or Ctrl+C to cancel..."
$null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")

Write-Host ""
Write-Host "???????????????????????????????????????" -ForegroundColor Cyan
Write-Host "STEP 1: Add files to .vcxproj" -ForegroundColor Yellow
Write-Host "???????????????????????????????????????" -ForegroundColor Cyan

& ".\add_ocr_files_to_project.ps1"
if ($LASTEXITCODE -ne 0) {
    Write-Host ""
    Write-Host "ERROR in Step 1!" -ForegroundColor Red
    exit 1
}

Write-Host ""
Write-Host "???????????????????????????????????????" -ForegroundColor Cyan
Write-Host "STEP 2: Update .vcxproj.filters" -ForegroundColor Yellow
Write-Host "???????????????????????????????????????" -ForegroundColor Cyan

& ".\fix_filters_file.ps1"
if ($LASTEXITCODE -ne 0) {
    Write-Host ""
    Write-Host "ERROR in Step 2!" -ForegroundColor Red
    exit 1
}

Write-Host ""
Write-Host "???????????????????????????????????????" -ForegroundColor Cyan
Write-Host "STEP 3: Force MOC compilation" -ForegroundColor Yellow
Write-Host "???????????????????????????????????????" -ForegroundColor Cyan

& ".\force_moc_compile.ps1"
if ($LASTEXITCODE -ne 0) {
    Write-Host ""
    Write-Host "ERROR in Step 3!" -ForegroundColor Red
    Write-Host ""
    Write-Host "???????????????????????????????????????" -ForegroundColor Yellow
    Write-Host "TRYING ALTERNATIVE: Complete rebuild" -ForegroundColor Yellow
    Write-Host "???????????????????????????????????????" -ForegroundColor Yellow
    
    & ".\fix_ocr_build_complete.ps1"
    if ($LASTEXITCODE -ne 0) {
        Write-Host ""
        Write-Host "??????????????????????????????????????????" -ForegroundColor Red
        Write-Host "?        BUILD FAILED                    ?" -ForegroundColor Red
        Write-Host "??????????????????????????????????????????" -ForegroundColor Red
        Write-Host ""
        Write-Host "The automated fix failed. Please try:" -ForegroundColor Yellow
        Write-Host ""
        Write-Host "MANUAL FIX IN VISUAL STUDIO:" -ForegroundColor Cyan
        Write-Host "  1. Open Naghuma Toolbox.sln" -ForegroundColor White
        Write-Host "  2. In Solution Explorer, find src\moc_OCRDialog.cpp" -ForegroundColor White
        Write-Host "  3. Right-click -> Exclude From Project" -ForegroundColor White
        Write-Host "  4. Right-click project -> Save" -ForegroundColor White
        Write-Host "  5. Right-click -> Add -> Existing Item" -ForegroundColor White
        Write-Host "  6. Select src\moc_OCRDialog.cpp" -ForegroundColor White
        Write-Host "  7. Right-click moc_OCRDialog.cpp -> Compile" -ForegroundColor White
        Write-Host "  8. Build -> Rebuild Solution" -ForegroundColor White
        Write-Host ""
        exit 1
    }
}

Write-Host ""
Write-Host "??????????????????????????????????????????" -ForegroundColor Green
Write-Host "?      ALL STEPS COMPLETED!              ?" -ForegroundColor Green
Write-Host "??????????????????????????????????????????" -ForegroundColor Green
Write-Host ""

# Final verification
if (Test-Path "x64\Debug\Naghuma Toolbox.exe") {
    Write-Host "? Executable built successfully" -ForegroundColor Green
    
    # Check for MOC object file
    if (Test-Path "x64\Debug\moc_OCRDialog.obj") {
        Write-Host "? MOC file compiled successfully" -ForegroundColor Green
    } else {
        Write-Host "? MOC object file not found (may still work)" -ForegroundColor Yellow
    }
    
    # Check DLLs
    Write-Host ""
    Write-Host "Checking critical DLLs..." -ForegroundColor Cyan
    $criticalDlls = @("tesseract55d.dll", "leptonica-1.85.0d.dll", "Qt6Cored.dll")
    $missingDlls = @()
    
    foreach ($dll in $criticalDlls) {
        if (Test-Path "x64\Debug\$dll") {
            Write-Host "  ? $dll" -ForegroundColor Green
        } else {
            Write-Host "  ? $dll" -ForegroundColor Red
            $missingDlls += $dll
        }
    }
    
    if ($missingDlls.Count -gt 0) {
        Write-Host ""
        Write-Host "? Missing DLLs detected!" -ForegroundColor Yellow
        Write-Host "Copy them with: .\verify_all_dlls.ps1" -ForegroundColor Cyan
        Write-Host ""
    }
    
    Write-Host ""
    Write-Host "??????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host "?     OCR IS READY TO USE!               ?" -ForegroundColor Green
    Write-Host "??????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "How to test:" -ForegroundColor Yellow
    Write-Host "  1. Run: .\x64\Debug\`"Naghuma Toolbox.exe`"" -ForegroundColor White
    Write-Host "  2. Load an image with text" -ForegroundColor White
    Write-Host "  3. Menu: Process -> OCR - Text Recognition..." -ForegroundColor White
    Write-Host "  4. Adjust preprocessing" -ForegroundColor White
    Write-Host "  5. Click 'Recognize Text'" -ForegroundColor White
    Write-Host ""
    
    # Offer to run
    Write-Host "Launch application now? (Y/N): " -NoNewline -ForegroundColor Yellow
    $response = Read-Host
    if ($response -eq 'Y' -or $response -eq 'y') {
        Write-Host ""
        Write-Host "Launching..." -ForegroundColor Green
        Start-Process "x64\Debug\Naghuma Toolbox.exe"
    }
    
} else {
    Write-Host "??????????????????????????????????????????" -ForegroundColor Red
    Write-Host "?   EXECUTABLE NOT FOUND!                ?" -ForegroundColor Red
    Write-Host "??????????????????????????????????????????" -ForegroundColor Red
    Write-Host ""
    Write-Host "Build may have failed. Check error messages above." -ForegroundColor Yellow
    Write-Host ""
    exit 1
}

Write-Host ""
